## 七、状态机流转规则

### 7.1 默认工作流状态

| 状态 | 类型 | 图标 | 颜色 | 说明 |
|------|------|------|------|------|
| Backlog | backlog | ○（虚线圆） | 灰色 | 待规划 |
| Todo | unstarted | ○（空心圆） | 灰色 | 待开始 |
| In Progress | started | ◐（黄色半圆） | 黄色 | 进行中 |
| In Review | started | ⊕（绿色加号圆）| 绿色 | 审核中 |
| Done | completed | ✓（蓝色勾选）| 蓝色 | 已完成 |
| Cancelled | cancelled | ✗（灰色叉号）| 灰色 | 已取消 |
| Duplicate | cancelled | ✗（灰色叉号）| 灰色 | 重复 |

### 7.2 状态类型分类

Linear 将状态分为 5 种类型：

| 类型 | 含义 | 统计归类 |
|------|------|---------|
| `backlog` | 未纳入计划 | 不计入活跃 |
| `unstarted` | 待开始 | 活跃但未开始 |
| `started` | 进行中 | 活跃且进行中 |
| `completed` | 已完成 | 已完成 |
| `cancelled` | 已取消 | 已取消 |

### 7.3 状态转换矩阵

#### 默认转换规则

```
┌─────────────┬───────────────────────────────────────────────────────┐
│ 从 \ 到     │ Backlog │ Todo │ In Progress │ In Review │ Done │ Cancelled │
├─────────────┼─────────┼──────┼─────────────┼───────────┼──────┼──────────┤
│ Backlog     │    -    │  ✅  │     ✅      │    ❌     │  ❌  │    ✅     │
│ Todo        │    ✅   │  -   │     ✅      │    ✅     │  ✅  │    ✅     │
│ In Progress │    ✅   │  ✅  │     -       │    ✅     │  ✅  │    ✅     │
│ In Review   │    ✅   │  ✅  │     ✅      │    -      │  ✅  │    ✅     │
│ Done        │    ❌   │  ✅  │     ✅      │    ✅     │  -   │    ❌     │
│ Cancelled   │    ❌   │  ✅  │     ✅      │    ✅     │  ✅  │    -      │
└─────────────┴─────────┴──────┴─────────────┴───────────┴──────┴──────────┘

✅ = 允许转换
❌ = 不允许转换（需特殊权限或不可逆）
- = 同状态
```

#### 转换约束

| 转换 | 约束条件 |
|------|---------|
| Done → Backlog | ❌ 禁止（需先 Reopen） |
| Done → Cancelled | ❌ 禁止（已完成不能再取消） |
| Cancelled → Backlog | ❌ 禁止（需先 Reopen） |
| Backlog → In Review | ❌ 禁止（需先进入 Todo 或 In Progress） |
| Backlog → Done | ❌ 禁止（需先进入活跃状态） |

### 7.4 状态转换触发器

#### 7.4.1 自动状态流转（Git 集成）

| 触发事件 | 状态变更 |
|---------|---------|
| PR 创建（引用 Issue） | → In Review |
| PR 合并 | → Done |
| PR 关闭（未合并） | → 原状态（或 Todo） |
| Commit 推送（引用 Issue） | → In Progress |
| Branch 创建（包含 Issue ID）| → In Progress |

**配置示例**：
```yaml
# GitHub 集成规则配置
automation:
  on_pr_created:
    action: update_status
    target: in_review
    conditions:
      - issue_status: [backlog, todo, in_progress]

  on_pr_merged:
    action: update_status
    target: done
    conditions:
      - issue_status: [in_progress, in_review]

  on_commit:
    action: update_status
    target: in_progress
    conditions:
      - issue_status: [backlog, todo]
```

#### 7.4.2 子任务联动

| 场景 | 行为 |
|------|------|
| 所有子任务完成 | 建议父 Issue 状态变更为 Done |
| 父 Issue 完成时 | 提示未完成的子任务 |
| 父 Issue 取消时 | 子任务状态询问（取消/保留） |

### 7.5 状态转换数据库设计

```sql
-- 状态转换规则表
CREATE TABLE workflow_transition (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workflow_id UUID NOT NULL REFERENCES workflow(id) ON DELETE CASCADE,
    from_state_id UUID REFERENCES workflow_state(id) ON DELETE CASCADE, -- NULL 表示任意状态
    to_state_id UUID NOT NULL REFERENCES workflow_state(id),
    trigger_type VARCHAR(50), -- 'manual', 'pr_created', 'pr_merged', 'commit'
    trigger_config JSONB,
    requires_permission VARCHAR(50), -- 'member', 'admin', 'team_owner'
    position FLOAT DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 状态转换历史记录
CREATE TABLE issue_status_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    issue_id UUID NOT NULL REFERENCES issue(id) ON DELETE CASCADE,
    from_status_id UUID REFERENCES workflow_state(id),
    to_status_id UUID NOT NULL REFERENCES workflow_state(id),
    changed_by_id UUID NOT NULL REFERENCES "user"(id),
    reason VARCHAR(255),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_status_history_issue ON issue_status_history(issue_id);
CREATE INDEX idx_status_history_time ON issue_status_history(created_at);
```

### 7.6 状态机实现（Go 示例）

```go
// 状态机服务
type WorkflowStateMachine struct {
    db *gorm.DB
}

// 状态类型
type StateType string

const (
    StateTypeBacklog    StateType = "backlog"
    StateTypeUnstarted  StateType = "unstarted"
    StateTypeStarted    StateType = "started"
    StateTypeCompleted  StateType = "completed"
    StateTypeCancelled  StateType = "cancelled"
)

// 转换规则
type TransitionRule struct {
    FromType  StateType
    ToType    StateType
    Allowed   bool
    Condition func(*Issue) bool
}

// 默认转换规则
var defaultTransitionRules = []TransitionRule{
    // Backlog 可以转换到
    {FromType: StateTypeBacklog, ToType: StateTypeUnstarted, Allowed: true},
    {FromType: StateTypeBacklog, ToType: StateTypeStarted, Allowed: true},
    {FromType: StateTypeBacklog, ToType: StateTypeCancelled, Allowed: true},

    // Done 不能转换到
    {FromType: StateTypeCompleted, ToType: StateTypeBacklog, Allowed: false},
    {FromType: StateTypeCompleted, ToType: StateTypeCancelled, Allowed: false},

    // 其他规则...
}

// 检查转换是否允许
func (sm *WorkflowStateMachine) CanTransition(issue *Issue, toState *WorkflowState) (bool, error) {
    fromState, err := sm.getStateByID(issue.StatusID)
    if err != nil {
        return false, err
    }

    // 检查转换规则
    for _, rule := range defaultTransitionRules {
        if rule.FromType == StateType(fromState.Type) &&
           rule.ToType == StateType(toState.Type) {
            if !rule.Allowed {
                return false, nil
            }
            if rule.Condition != nil && !rule.Condition(issue) {
                return false, nil
            }
            return true, nil
        }
    }

    // 默认允许
    return true, nil
}

// 执行状态转换
func (sm *WorkflowStateMachine) Transition(
    ctx context.Context,
    issueID uuid.UUID,
    toStateID uuid.UUID,
    userID uuid.UUID,
) error {
    return sm.db.Transaction(func(tx *gorm.DB) error {
        // 1. 获取 Issue 和目标状态
        var issue Issue
        if err := tx.First(&issue, "id = ?", issueID).Error; err != nil {
            return err
        }

        var toState WorkflowState
        if err := tx.First(&toState, "id = ?", toStateID).Error; err != nil {
            return err
        }

        // 2. 检查转换是否允许
        allowed, err := sm.CanTransition(&issue, &toState)
        if err != nil {
            return err
        }
        if !allowed {
            return errors.New("transition not allowed")
        }

        // 3. 记录历史
        history := IssueStatusHistory{
            IssueID:      issueID,
            FromStatusID: issue.StatusID,
            ToStatusID:   toStateID,
            ChangedByID:  userID,
        }
        if err := tx.Create(&history).Error; err != nil {
            return err
        }

        // 4. 更新 Issue
        updates := map[string]interface{}{
            "status_id": toStateID,
        }

        // 根据目标状态类型更新时间戳
        switch toState.Type {
        case "completed":
            updates["completed_at"] = time.Now()
        case "cancelled":
            updates["cancelled_at"] = time.Now()
        }

        return tx.Model(&issue).Updates(updates).Error
    })
}
```

### 7.7 自定义工作流配置

```json
{
  "team_id": "eng-team",
  "workflow": {
    "states": [
      {"id": "backlog", "name": "Backlog", "type": "backlog", "color": "#6B7280"},
      {"id": "ready", "name": "Ready", "type": "unstarted", "color": "#9CA3AF"},
      {"id": "in-progress", "name": "In Progress", "type": "started", "color": "#F59E0B"},
      {"id": "in-review", "name": "In Review", "type": "started", "color": "#10B981"},
      {"id": "testing", "name": "Testing", "type": "started", "color": "#8B5CF6"},
      {"id": "done", "name": "Done", "type": "completed", "color": "#3B82F6"}
    ],
    "transitions": [
      {"from": "backlog", "to": "ready"},
      {"from": "ready", "to": "in-progress"},
      {"from": "in-progress", "to": "in-review"},
      {"from": "in-review", "to": "testing"},
      {"from": "in-review", "to": "done"},
      {"from": "testing", "to": "done"},
      {"from": "*", "to": "cancelled"}
    ],
    "automation": {
      "pr_created": {"transition_to": "in-review"},
      "pr_merged": {"transition_to": "done"}
    }
  }
}
```

---

