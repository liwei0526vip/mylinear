## 九、权限矩阵

### 9.1 角色定义

| 角色 | 层级 | 说明 |
|------|------|------|
| Workspace Owner | 工作区 | 最高权限，管理工作区设置和所有团队 |
| Admin | 工作区 | 管理工作区设置、团队成员 |
| Member | 团队 | 普通成员，日常工作 |
| Team Owner | 团队 | 管理团队设置、标签、模板、成员 |
| Guest | 团队 | 访客，受限访问（Plus+） |

### 9.2 工作区级权限矩阵

| 资源/操作 | Workspace Owner | Admin | Member | Team Owner | Guest |
|----------|:---------------:|:-----:|:------:|:----------:|:-----:|
| 查看工作区设置 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 修改工作区设置 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 删除工作区 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 创建团队 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 管理所有团队 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 邀请成员 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 移除成员 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 更改成员角色 | ✅ | ✅ | ❌ | ❌ | ❌ |
| SSO/SCIM 配置 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 审计日志查看 | ✅ | ❌ | ❌ | ❌ | ❌ |

### 9.3 团队级权限矩阵

| 资源/操作 | Team Owner | Member | Guest |
|----------|:----------:|:------:|:-----:|
| **团队设置** ||||
| 查看团队 | ✅ | ✅ | ✅ |
| 修改团队设置 | ✅ | ❌ | ❌ |
| 删除团队 | ✅ | ❌ | ❌ |
| 添加/移除团队成员 | ✅ | ❌ | ❌ |
| 管理标签 | ✅ | ❌ | ❌ |
| 管理工作流 | ✅ | ❌ | ❌ |
| 管理模板 | ✅ | ❌ | ❌ |
| **Issue** ||||
| 查看 Issue | ✅ | ✅ | ✅* |
| 创建 Issue | ✅ | ✅ | ❌ |
| 编辑 Issue | ✅ | ✅ | ❌ |
| 删除 Issue | ✅ | ✅ | ❌ |
| 分配 Issue | ✅ | ✅ | ❌ |
| 修改 Issue 状态 | ✅ | ✅ | ❌ |
| 评论 | ✅ | ✅ | ❌ |
| **Project** ||||
| 查看 Project | ✅ | ✅ | ✅* |
| 创建 Project | ✅ | ✅ | ❌ |
| 编辑 Project | ✅ | ✅ | ❌ |
| 删除 Project | ✅ | ❌ | ❌ |
| **Cycle** ||||
| 查看 Cycle | ✅ | ✅ | ✅* |
| 管理 Cycle | ✅ | ✅ | ❌ |

\* Guest 只能访问其所属团队的资源

### 9.4 资源访问控制规则

#### 9.4.1 私有团队访问

```go
// 检查用户是否可以访问团队
func (s *AuthService) CanAccessTeam(userID, teamID uuid.UUID) (bool, error) {
    var team Team
    if err := s.db.First(&team, "id = ?", teamID).Error; err != nil {
        return false, err
    }

    // 公开团队：所有工作区成员可访问
    if !team.IsPrivate {
        return s.isWorkspaceMember(userID, team.WorkspaceID)
    }

    // 私有团队：只有团队成员可访问
    return s.isTeamMember(userID, teamID)
}

// 检查用户是否可以访问 Issue
func (s *AuthService) CanAccessIssue(userID, issueID uuid.UUID) (bool, error) {
    var issue Issue
    if err := s.db.Preload("Team").First(&issue, "id = ?", issueID).Error; err != nil {
        return false, err
    }

    return s.CanAccessTeam(userID, issue.TeamID)
}
```

#### 9.4.2 字段级权限

```go
// Issue 字段权限检查
var issueFieldPermissions = map[string]map[UserRole]bool{
    "title":       {RoleMember: true, RoleGuest: false},
    "description": {RoleMember: true, RoleGuest: false},
    "status":      {RoleMember: true, RoleGuest: false},
    "priority":    {RoleMember: true, RoleGuest: false},
    "assignee":    {RoleMember: true, RoleGuest: false},
    "project":     {RoleMember: true, RoleGuest: false},
    "cycle":       {RoleMember: true, RoleGuest: false},
    "due_date":    {RoleMember: true, RoleGuest: false},
    "sla":         {RoleAdmin: true, RoleMember: false},
}

func (s *AuthService) CanEditField(userRole UserRole, field string) bool {
    perms, ok := issueFieldPermissions[field]
    if !ok {
        return true // 默认允许
    }

    allowed, ok := perms[userRole]
    return ok && allowed
}
```

### 9.5 权限中间件实现

```go
// GraphQL 权限中间件
func PermissionMiddleware(roleRequired UserRole) graphql.Middleware {
    return func(next graphql.Handler) graphql.Handler {
        return func(ctx context.Context, req *graphql.Request) *graphql.Response {
            // 从 context 获取用户
            user, ok := ctx.Value("user").(*User)
            if !ok {
                return graphql.ErrorResponse("unauthorized")
            }

            // 检查角色
            if !hasRequiredRole(user.Role, roleRequired) {
                return graphql.ErrorResponse("forbidden")
            }

            return next(ctx, req)
        }
    }
}

// 资源访问中间件
func ResourceAccessMiddleware(resourceType string) graphql.Middleware {
    return func(next graphql.Handler) graphql.Handler {
        return func(ctx context.Context, req *graphql.Request) *graphql.Response {
            user := ctx.Value("user").(*User)
            resourceID := req.Variables["id"].(string)

            authService := GetAuthService()
            hasAccess, err := authService.CanAccessResource(
                user.ID,
                resourceType,
                uuid.MustParse(resourceID),
            )
            if err != nil || !hasAccess {
                return graphql.ErrorResponse("access denied")
            }

            return next(ctx, req)
        }
    }
}
```

---

### 9.6 权限体系设计分析

#### 5 级角色分层架构

```
Workspace Owner → Admin → Team Owner → Member → Guest
   (全局最高)     (管理)    (团队管理)   (日常)   (只读)
```

#### 设计要点

| 设计决策 | 说明 |
|---------|------|
| 公共/私有团队 | 公共团队所有工作区成员可见，私有团队仅成员可见（Plus 功能） |
| 字段级权限 | 细粒度控制，如 SLA 字段仅 Admin 可编辑 |
| 资源访问隔离 | Issue 访问权限继承自所属 Team 的访问权限 |
| 中间件拦截 | 通过 GraphQL 权限中间件和资源访问中间件两层检查 |

#### 最佳实践

- 权限检查统一在中间件层处理，避免在业务逻辑中散落权限判断
- 私有团队的 Issue 检索需要在数据库查询层面过滤，而不是在应用层过滤（避免分页数据不一致）
- Guest 角色的引入需要考虑跨团队资源引用的可见性边界

---
