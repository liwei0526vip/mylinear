## 十三、导入导出与审计

### 13.1 导入功能

#### 13.1.1 Jira 导入映射

| Jira 字段 | Linear 字段 | 转换规则 |
|-----------|------------|---------|
| Summary | title | 直接映射 |
| Description | description | 转换 Markdown |
| Status | status | 映射到工作流状态 |
| Priority | priority | 映射优先级 |
| Assignee | assignee | 邮箱匹配用户 |
| Reporter | creator | 邮箱匹配用户 |
| Labels | labels | 直接映射 |
| Fix Version | milestone | 创建/映射里程碑 |
| Epic Link | project | 创建/映射项目 |
| Sprint | cycle | 创建/映射 Cycle |
| Comments | comments | 转换格式 |
| Attachments | attachments | 重新上传 |

#### 13.1.2 CSV 导入格式

```csv
Title,Description,Status,Priority,Assignee,Labels,Due Date,Project
"Fix login bug","Detailed description...","In Progress","High","john@example.com","bug,auth","2026-02-20","Auth System"
```

#### 13.1.3 导入 API

```graphql
mutation ImportIssues($file: Upload!, $teamId: ID!, $mapping: ImportMappingInput!) {
  issueImport(file: $file, teamId: $teamId, mapping: $mapping) {
    id
    status
    totalCount
    importedCount
    errorCount
    errors {
      row
      message
    }
  }
}
```

### 13.2 导出功能

#### 13.2.1 CSV 导出格式

```csv
ID,Title,Status,Priority,Assignee,Labels,Due Date,Project,Cycle,Created At,Updated At
ENG-123,"Fix login bug","In Progress","High","John Doe","bug,auth","2026-02-20","Auth System","Sprint 5","2026-02-01","2026-02-15"
```

#### 13.2.2 导出 API

```graphql
query ExportIssues($filter: IssueFilterInput, $format: ExportFormat!) {
  issueExport(filter: $filter, format: $format) {
    downloadUrl
    expiresAt
    totalCount
  }
}

enum ExportFormat {
  CSV
  JSON
  MARKDOWN
}
```

### 13.3 审计日志

#### 13.3.1 审计事件类型

| 类别 | 事件类型 | 说明 |
|------|---------|------|
| **认证** | `auth.login` | 用户登录 |
| | `auth.logout` | 用户登出 |
| | `auth.token.create` | API Token 创建 |
| | `auth.token.revoke` | API Token 撤销 |
| **授权** | `role.assign` | 角色分配 |
| | `role.revoke` | 角色撤销 |
| | `team.join` | 加入团队 |
| | `team.leave` | 离开团队 |
| **数据变更** | `issue.create` | Issue 创建 |
| | `issue.update` | Issue 更新 |
| | `issue.delete` | Issue 删除 |
| | `project.create` | 项目创建 |
| | `settings.update` | 设置更新 |
| **配置变更** | `workflow.create` | 工作流创建 |
| | `integration.connect` | 集成连接 |
| | `integration.disconnect` | 集成断开 |
| | `webhook.create` | Webhook 创建 |

#### 13.3.2 审计日志结构

```json
{
  "id": "audit-uuid",
  "type": "issue.update",
  "actor": {
    "id": "user-uuid",
    "name": "John Doe",
    "email": "john@example.com",
    "ip": "192.168.1.1"
  },
  "resource": {
    "type": "issue",
    "id": "issue-uuid",
    "identifier": "ENG-123"
  },
  "changes": {
    "status": {
      "from": "Todo",
      "to": "In Progress"
    }
  },
  "context": {
    "userAgent": "Mozilla/5.0...",
    "clientId": "web-app"
  },
  "createdAt": "2026-02-15T10:30:00.000Z"
}
```

#### 13.3.3 审计日志保留策略

| 计划 | 保留时间 |
|------|---------|
| Free | 7 天 |
| Standard | 30 天 |
| Plus | 90 天 |
| Enterprise | 可配置（最长 1 年） |

#### 13.3.4 审计日志查询 API

```graphql
query AuditLogs(
  $filter: AuditLogFilterInput
  $first: Int
  $after: String
) {
  auditLogs(filter: $filter, first: $first, after: $after) {
    edges {
      node {
        id
        type
        actor {
          name
          email
        }
        resource {
          type
          id
        }
        changes
        createdAt
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
  }
}

input AuditLogFilterInput {
  types: [String!]
  actorId: ID
  resourceType: String
  resourceId: ID
  startDate: DateTime
  endDate: DateTime
}
```

---

### 13.4 导入导出与审计设计分析

#### 导入功能要点

- Jira 映射是最关键的导入路径（Epic→Project / Sprint→Cycle / Fix Version→Milestone）
- CSV 导入支持错误行定位和报告，容忍部分行失败
- 附件导入需要重新上传到自有存储

#### 审计日志设计要点

- 记录完整的 Actor（谁）+ Resource（改了什么）+ Changes（从什么改到什么）+ Context（User-Agent、IP）
- 保留策略按计划分级（Free 7天 → Enterprise 可配置最长 1 年）
- 审计日志应设计为追加写入（append-only），不可修改或删除

---
